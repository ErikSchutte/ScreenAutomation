name: CodeQL

on:
  push: { branches: [ "main" ] }
  pull_request: { branches: [ "main" ] }
  schedule: [ { cron: "0 6 * * 0" } ]  # weekly

jobs:
  analyze:
    runs-on: windows-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      # NuGet cache (safe keys; no deadlocks)
      - name: Cache NuGet
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/*.csproj') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - run: dotnet restore

      - uses: github/codeql-action/init@v3
        with:
          languages: csharp

      # ðŸ‘‡ Build BEFORE analyze so CodeQL sees the code
      - run: dotnet build --configuration Release --no-restore

      - uses: github/codeql-action/analyze@v3
